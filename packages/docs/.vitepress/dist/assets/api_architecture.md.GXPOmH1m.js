import{_ as n,o as a,c as e,ag as l}from"./chunks/framework.DEqXEGcv.js";const u=JSON.parse('{"title":"Architecture","description":"","frontmatter":{},"headers":[],"relativePath":"api/architecture.md","filePath":"api/architecture.md"}'),p={name:"api/architecture.md"};function r(t,s,o,c,i,d){return a(),e("div",null,[...s[0]||(s[0]=[l(`<h1 id="architecture" tabindex="-1">Architecture <a class="header-anchor" href="#architecture" aria-label="Permalink to &quot;Architecture&quot;">​</a></h1><p>Deep dive into how ArbiLink works under the hood.</p><h2 id="system-overview" tabindex="-1">System Overview <a class="header-anchor" href="#system-overview" aria-label="Permalink to &quot;System Overview&quot;">​</a></h2><div class="language- line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>Arbitrum Sepolia (Source Chain)</span></span>
<span class="line"><span>┌─────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│                                                         │</span></span>
<span class="line"><span>│  User / dApp                                            │</span></span>
<span class="line"><span>│     │                                                   │</span></span>
<span class="line"><span>│     │  sendMessage(chainId, target, data)               │</span></span>
<span class="line"><span>│     ▼                                                   │</span></span>
<span class="line"><span>│  MessageHub.sol (Rust / Stylus / WASM)                  │</span></span>
<span class="line"><span>│     │  - Validates chainId is registered                │</span></span>
<span class="line"><span>│     │  - Validates fee ≥ minimum                        │</span></span>
<span class="line"><span>│     │  - Assigns messageId (auto-increment)             │</span></span>
<span class="line"><span>│     │  - Stores message in mapping                      │</span></span>
<span class="line"><span>│     │  - Emits MessageSent event                        │</span></span>
<span class="line"><span>│     │  - Sets status = PENDING                          │</span></span>
<span class="line"><span>│                                                         │</span></span>
<span class="line"><span>└─────────────────────────────────────────────────────────┘</span></span>
<span class="line"><span>                     │</span></span>
<span class="line"><span>                     │  Off-chain: Relayer watches MessageSent</span></span>
<span class="line"><span>                     ▼</span></span>
<span class="line"><span>┌─────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  Relayer Node (off-chain, staked)                       │</span></span>
<span class="line"><span>│     │  - Listens to Arbitrum Sepolia events             │</span></span>
<span class="line"><span>│     │  - Picks up MessageSent                           │</span></span>
<span class="line"><span>│     │  - Signs execution proof (ECDSA)                  │</span></span>
<span class="line"><span>│     │  - Calls receiveMessage() on destination          │</span></span>
<span class="line"><span>└─────────────────────────────────────────────────────────┘</span></span>
<span class="line"><span>                     │</span></span>
<span class="line"><span>                     ▼</span></span>
<span class="line"><span>Destination Chain (Ethereum / Base / Polygon / …)</span></span>
<span class="line"><span>┌─────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  ArbiLinkReceiver.sol                                   │</span></span>
<span class="line"><span>│     │  - Verifies ECDSA proof from relayer              │</span></span>
<span class="line"><span>│     │  - Checks message not already processed           │</span></span>
<span class="line"><span>│     │  - Calls target.call(data)                        │</span></span>
<span class="line"><span>│     │  - Records receipt                                │</span></span>
<span class="line"><span>│     │  - Emits MessageReceived                          │</span></span>
<span class="line"><span>│     ▼                                                   │</span></span>
<span class="line"><span>│  Your Contract (target)                                 │</span></span>
<span class="line"><span>│     │  - Executes arbitrary logic                       │</span></span>
<span class="line"><span>│     │  - msg.sender = ArbiLinkReceiver                  │</span></span>
<span class="line"><span>└─────────────────────────────────────────────────────────┘</span></span>
<span class="line"><span>                     │</span></span>
<span class="line"><span>                     │  Relayer reports back</span></span>
<span class="line"><span>                     ▼</span></span>
<span class="line"><span>┌─────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│  MessageHub (Arbitrum Sepolia)                          │</span></span>
<span class="line"><span>│     │  - confirm_delivery(messageId)                    │</span></span>
<span class="line"><span>│     │  - Starts 5-min challenge window                  │</span></span>
<span class="line"><span>│     │  - After window: status = CONFIRMED               │</span></span>
<span class="line"><span>│     │  - Relayer stake returned + fee paid              │</span></span>
<span class="line"><span>└─────────────────────────────────────────────────────────┘</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div><h2 id="message-lifecycle" tabindex="-1">Message Lifecycle <a class="header-anchor" href="#message-lifecycle" aria-label="Permalink to &quot;Message Lifecycle&quot;">​</a></h2><table tabindex="0"><thead><tr><th>Phase</th><th>Contract</th><th>Event</th><th>Duration</th></tr></thead><tbody><tr><td><strong>Sent</strong></td><td>MessageHub</td><td><code>MessageSent</code></td><td>Instant</td></tr><tr><td><strong>Relayed</strong></td><td>ArbiLinkReceiver</td><td><code>MessageReceived</code></td><td>~2–5 seconds</td></tr><tr><td><strong>Challenge Window</strong></td><td>MessageHub</td><td>—</td><td>300 seconds</td></tr><tr><td><strong>Confirmed</strong></td><td>MessageHub</td><td><code>MessageFinalized</code></td><td>After window</td></tr></tbody></table><h2 id="security-model" tabindex="-1">Security Model <a class="header-anchor" href="#security-model" aria-label="Permalink to &quot;Security Model&quot;">​</a></h2><h3 id="optimistic-delivery" tabindex="-1">Optimistic Delivery <a class="header-anchor" href="#optimistic-delivery" aria-label="Permalink to &quot;Optimistic Delivery&quot;">​</a></h3><p>ArbiLink uses an <strong>optimistic</strong> approach — messages are executed immediately on the destination, then secured retroactively.</p><ol><li>Relayer executes the message</li><li>Relayer calls <code>confirm_delivery(messageId)</code> on MessageHub</li><li>A 5-minute challenge window opens</li><li>Anyone can call <code>challenge_message(messageId)</code> if they believe the delivery was fraudulent</li><li>If challenged, the MessageHub verifies against the execution proof</li><li>If invalid: relayer is <strong>slashed</strong>, stake goes to challenger</li><li>If valid: challenge is rejected, window continues</li><li>After window closes: <code>finalize_message()</code> → <code>CONFIRMED</code>, stake returned</li></ol><h3 id="relayer-incentives" tabindex="-1">Relayer Incentives <a class="header-anchor" href="#relayer-incentives" aria-label="Permalink to &quot;Relayer Incentives&quot;">​</a></h3><div class="language- line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>Relayer earns:  message.fee (paid by sender)</span></span>
<span class="line"><span>Relayer risks:  RELAYER_STAKE (0.1 ETH) — slashed on fraud</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Expected value (honest):    fee × messages_delivered</span></span>
<span class="line"><span>Expected value (fraudulent): slashAmount × P(caught)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Since P(caught) ≈ 1 (permissionless challenge), fraud is irrational.</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="replay-protection" tabindex="-1">Replay Protection <a class="header-anchor" href="#replay-protection" aria-label="Permalink to &quot;Replay Protection&quot;">​</a></h3><p><code>ArbiLinkReceiver</code> maintains a <code>processedMessages</code> mapping:</p><div class="language-solidity line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">solidity</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">mapping</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">uint256</span><span style="color:#F97583;"> =&gt;</span><span style="color:#79B8FF;"> bool</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> processedMessages;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">function</span><span style="color:#B392F0;"> receiveMessage</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">uint256</span><span style="color:#FFAB70;"> messageId</span><span style="color:#E1E4E8;">, ...) </span><span style="color:#F97583;">external</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">    require</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">processedMessages[messageId], </span><span style="color:#9ECBFF;">&quot;Already processed&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    processedMessages[messageId] </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> true</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#6A737D;">    // ... execute</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="ecdsa-execution-proof" tabindex="-1">ECDSA Execution Proof <a class="header-anchor" href="#ecdsa-execution-proof" aria-label="Permalink to &quot;ECDSA Execution Proof&quot;">​</a></h3><p>Every delivery requires a signature proving the message was actually executed:</p><div class="language- line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span>proof = ECDSA.sign(</span></span>
<span class="line"><span>    keccak256(abi.encodePacked(messageId, target, data, success)),</span></span>
<span class="line"><span>    relayerPrivateKey</span></span>
<span class="line"><span>)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>The receiver verifies <code>proof</code> against the registered relayer address before executing.</p><h2 id="arbitrum-stylus-rust" tabindex="-1">Arbitrum Stylus (Rust) <a class="header-anchor" href="#arbitrum-stylus-rust" aria-label="Permalink to &quot;Arbitrum Stylus (Rust)&quot;">​</a></h2><p><code>MessageHub</code> is written in <strong>Rust</strong> and compiled to WASM via the Stylus SDK:</p><div class="language-rust line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#E1E4E8;">#[stylus_sdk</span><span style="color:#F97583;">::</span><span style="color:#E1E4E8;">prelude</span><span style="color:#F97583;">::</span><span style="color:#E1E4E8;">public]</span></span>
<span class="line"><span style="color:#F97583;">impl</span><span style="color:#B392F0;"> MessageHub</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">    pub</span><span style="color:#F97583;"> fn</span><span style="color:#B392F0;"> send_message</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#F97583;">        &amp;mut</span><span style="color:#79B8FF;"> self</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        chain_id</span><span style="color:#F97583;">:</span><span style="color:#B392F0;"> U256</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        target</span><span style="color:#F97583;">:</span><span style="color:#B392F0;"> Address</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        data</span><span style="color:#F97583;">:</span><span style="color:#B392F0;"> Bytes</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    ) </span><span style="color:#F97583;">-&gt;</span><span style="color:#B392F0;"> Result</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#B392F0;">U256</span><span style="color:#E1E4E8;">, </span><span style="color:#B392F0;">Vec</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#B392F0;">u8</span><span style="color:#E1E4E8;">&gt;&gt; {</span></span>
<span class="line"><span style="color:#F97583;">        let</span><span style="color:#E1E4E8;"> fee </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> self</span><span style="color:#F97583;">.</span><span style="color:#B392F0;">get_fee</span><span style="color:#E1E4E8;">(chain_id)</span><span style="color:#F97583;">?</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#B392F0;">        require!</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">msg</span><span style="color:#F97583;">::</span><span style="color:#B392F0;">value</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">&gt;=</span><span style="color:#E1E4E8;"> fee, </span><span style="color:#B392F0;">InsufficientFee</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">        let</span><span style="color:#E1E4E8;"> id </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;"> self</span><span style="color:#F97583;">.</span><span style="color:#E1E4E8;">message_count</span><span style="color:#F97583;">.</span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">+</span><span style="color:#B392F0;"> U256</span><span style="color:#F97583;">::</span><span style="color:#B392F0;">from</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#79B8FF;">        self</span><span style="color:#F97583;">.</span><span style="color:#E1E4E8;">message_count</span><span style="color:#F97583;">.</span><span style="color:#B392F0;">set</span><span style="color:#E1E4E8;">(id);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">        // Store and emit …</span></span>
<span class="line"><span style="color:#B392F0;">        Ok</span><span style="color:#E1E4E8;">(id)</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p><strong>Stylus advantages over Solidity for this use case:</strong></p><table tabindex="0"><thead><tr><th>Metric</th><th>Solidity</th><th>Stylus (Rust)</th></tr></thead><tbody><tr><td>Gas (send_message)</td><td>~80,000</td><td>~8,000</td></tr><tr><td>Bytecode size</td><td>~12 KB</td><td>~45 KB (compressed WASM)</td></tr><tr><td>Memory safety</td><td>No</td><td>Yes (Rust borrow checker)</td></tr><tr><td>Execution speed</td><td>EVM</td><td>WASM (~10×)</td></tr></tbody></table><h2 id="sdk-design" tabindex="-1">SDK Design <a class="header-anchor" href="#sdk-design" aria-label="Permalink to &quot;SDK Design&quot;">​</a></h2><p>The <code>@arbilink/sdk</code> abstracts the ABI calls and provides:</p><ol><li><strong>Fee calculation</strong> — calls <code>get_fee()</code> and caches result</li><li><strong>Message encoding</strong> — handles ABI encoding of <code>send_message</code> params</li><li><strong>Event parsing</strong> — extracts <code>messageId</code> from <code>MessageSent</code> log</li><li><strong>Status polling</strong> — wraps <code>get_message()</code> with exponential backoff</li><li><strong>Watch subscriptions</strong> — <code>setInterval</code> wrapper around <code>getMessageStatus</code></li></ol><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;">// Internally, sendMessage does:</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> tx</span><span style="color:#F97583;">     =</span><span style="color:#F97583;"> await</span><span style="color:#79B8FF;"> this</span><span style="color:#E1E4E8;">.hub.</span><span style="color:#B392F0;">send_message</span><span style="color:#E1E4E8;">(chainId, target, data, { value: fee });</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> receipt</span><span style="color:#F97583;"> =</span><span style="color:#F97583;"> await</span><span style="color:#E1E4E8;"> tx.</span><span style="color:#B392F0;">wait</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#79B8FF;"> log</span><span style="color:#F97583;">    =</span><span style="color:#E1E4E8;"> receipt.logs.</span><span style="color:#B392F0;">find</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">l</span><span style="color:#F97583;"> =&gt;</span><span style="color:#E1E4E8;"> hubInterface.</span><span style="color:#B392F0;">parseLog</span><span style="color:#E1E4E8;">(l)?.name </span><span style="color:#F97583;">===</span><span style="color:#9ECBFF;"> &#39;MessageSent&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> [</span><span style="color:#79B8FF;">id</span><span style="color:#E1E4E8;">]   </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> hubInterface.</span><span style="color:#B392F0;">parseLog</span><span style="color:#E1E4E8;">(log).args;</span></span>
<span class="line"><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> id;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div>`,28)])])}const y=n(p,[["render",r]]);export{u as __pageData,y as default};
